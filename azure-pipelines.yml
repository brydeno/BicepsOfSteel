trigger:
  branches:
    include:
      - master


resources:
  repositories:
    - repository: pipelinetemplates
      type: github
      name: builttoroam/pipeline_templates
      ref: refs/tags/v0.7.0
      endpoint: github

pool:
  vmImage: 'windows-latest'

variables:
  - name: bicep_filepath
    value: 'SimpleWithManagedIdentities/VanillaDeployment.bicep'
  - name: arm_template_filepath
    value: '$(Pipeline.Workspace)/BicepArtifacts/services.json'

stages:
- stage: Compile_Bicep
  pool:
    vmImage: 'ubuntu-latest'

  jobs:
  - job: Bicep
    steps:
      - task: AzureCLI@2
        displayName: Build ARM Template from bicep file
        inputs:
          azureSubscription: 'Azure'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az --version
            az bicep build --files SimpleWithManagedIdentities/VanillaDeployment.bicep

      - task: AzureResourceManagerTemplateDeployment@3
        displayName: 'Validate ARM Templates'
        inputs:
          azureResourceManagerConnection: 'Azure'
          subscriptionId: '92dba6c6-2cf8-46ad-9d75-8674f0f66b9a'
          resourceGroupName: 'testing'
          location: 'Australia East'
          csmFile: SimpleWithManagedIdentities/VanillaDeployment.json
          deploymentMode: Validation
